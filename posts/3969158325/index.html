<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.0"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.ico"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.ico"><link rel="mask-icon" href="/images/logo.svg" color="#222"><meta name="google-site-verification" content="Oe5X3we6LueobdVkYt_0OWN2MKIdhLA1ABWWwBtCInI"><meta name="baidu-site-verification" content="code-cAwJVzSa3d"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.3/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css"><script class="next-config" data-name="main" type="application/json">{&quot;hostname&quot;:&quot;undeio.me&quot;,&quot;root&quot;:&quot;&#x2F;&quot;,&quot;images&quot;:&quot;&#x2F;images&quot;,&quot;scheme&quot;:&quot;Gemini&quot;,&quot;version&quot;:&quot;8.4.0&quot;,&quot;exturl&quot;:false,&quot;sidebar&quot;:{&quot;position&quot;:&quot;left&quot;,&quot;display&quot;:&quot;post&quot;,&quot;padding&quot;:18,&quot;offset&quot;:12,&quot;width&quot;:300},&quot;copycode&quot;:true,&quot;bookmark&quot;:{&quot;enable&quot;:false,&quot;color&quot;:&quot;#222&quot;,&quot;save&quot;:&quot;auto&quot;},&quot;fancybox&quot;:false,&quot;mediumzoom&quot;:true,&quot;lazyload&quot;:true,&quot;pangu&quot;:false,&quot;comments&quot;:{&quot;style&quot;:&quot;tabs&quot;,&quot;active&quot;:null,&quot;storage&quot;:true,&quot;lazyload&quot;:false,&quot;nav&quot;:null},&quot;motion&quot;:{&quot;enable&quot;:true,&quot;async&quot;:false,&quot;transition&quot;:{&quot;post_block&quot;:&quot;fadeIn&quot;,&quot;post_header&quot;:&quot;fadeInDown&quot;,&quot;post_body&quot;:&quot;fadeInDown&quot;,&quot;coll_header&quot;:&quot;fadeInLeft&quot;,&quot;sidebar&quot;:&quot;fadeInUp&quot;}},&quot;prism&quot;:false,&quot;i18n&quot;:{&quot;placeholder&quot;:&quot;搜索...&quot;,&quot;empty&quot;:&quot;没有找到任何搜索结果：${query}&quot;,&quot;hits_time&quot;:&quot;找到 ${hits} 个搜索结果（用时 ${time} 毫秒）&quot;,&quot;hits&quot;:&quot;找到 ${hits} 个搜索结果&quot;},&quot;path&quot;:&quot;&#x2F;search.xml&quot;,&quot;localsearch&quot;:{&quot;enable&quot;:true,&quot;trigger&quot;:&quot;auto&quot;,&quot;top_n_per_article&quot;:1,&quot;unescape&quot;:false,&quot;preload&quot;:true}}</script><meta name="description" content="破坏原程序的输入表是加密外壳必备的功能，因此在脱壳中，输入表的处理是一个关键环节，这需要脱壳者对 PE 格式中输入表的概念必须非常清楚； 手动修复可以更清晰的理解重建输入表的过程及原理，但很辛苦，需要细心细心再细心，中间因为数值填错而苦苦寻找，想象一下在一堆二进制中找一个数值错误，很可怕，但很值得，弄懂了原理，以后就善用工具了；  使用工具 OllyDbg 1.10原版，简称OD； OD 汉化和"><meta property="og:type" content="article"><meta property="og:title" content="手动重建 IAT"><meta property="og:url" content="https://undeio.me/posts/3969158325/"><meta property="og:site_name" content="池塘·半亩"><meta property="og:description" content="破坏原程序的输入表是加密外壳必备的功能，因此在脱壳中，输入表的处理是一个关键环节，这需要脱壳者对 PE 格式中输入表的概念必须非常清楚； 手动修复可以更清晰的理解重建输入表的过程及原理，但很辛苦，需要细心细心再细心，中间因为数值填错而苦苦寻找，想象一下在一堆二进制中找一个数值错误，很可怕，但很值得，弄懂了原理，以后就善用工具了；  使用工具 OllyDbg 1.10原版，简称OD； OD 汉化和"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://tva1.sinaimg.cn/large/008eGmZEly1gnysy0v08kj31eb0u0ads.jpg"><meta property="og:image" content="https://tva1.sinaimg.cn/large/008eGmZEly1gnyszz3dehj31ef0u00x0.jpg"><meta property="og:image" content="https://tva1.sinaimg.cn/large/008eGmZEly1gnyt7wfurwj318v0u079r.jpg"><meta property="og:image" content="https://tva1.sinaimg.cn/large/008eGmZEly1gnyteiv2nrj31fq0u0n2f.jpg"><meta property="og:image" content="https://tva1.sinaimg.cn/large/008eGmZEly1gnytpedhm7j31ds0u0tde.jpg"><meta property="og:image" content="https://tva1.sinaimg.cn/large/008eGmZEly1gnyu1ofv8cj30so0is74t.jpg"><meta property="og:image" content="https://tva1.sinaimg.cn/large/008eGmZEly1gnyu86qvv6j30ys0jaab0.jpg"><meta property="og:image" content="https://tva1.sinaimg.cn/large/008eGmZEly1gnyub982ydj30pe0eyq3b.jpg"><meta property="og:image" content="https://tva1.sinaimg.cn/large/008eGmZEly1gnyuihwfs0j31e40u00vv.jpg"><meta property="og:image" content="https://tva1.sinaimg.cn/large/008eGmZEly1gnyux7yeyaj318b0u00xf.jpg"><meta property="og:image" content="https://tva1.sinaimg.cn/large/008eGmZEly1gnywqu2k84j31ue0h0qaq.jpg"><meta property="og:image" content="https://tva1.sinaimg.cn/large/008eGmZEly1gnyx9ny4d8j318f0u00vz.jpg"><meta property="og:image" content="https://tva1.sinaimg.cn/large/008eGmZEly1gnz01e8sjhj318c0u0q5p.jpg"><meta property="og:image" content="https://tva1.sinaimg.cn/large/008eGmZEly1gnz7h6rl86j30n60lsdg9.jpg"><meta property="og:image" content="https://tva1.sinaimg.cn/large/008eGmZEly1gnz7m49balj313806sdg1.jpg"><meta property="og:image" content="https://tva1.sinaimg.cn/large/008eGmZEly1gnz7r455y1j31dw0u0n0a.jpg"><meta property="og:image" content="https://tva1.sinaimg.cn/large/008eGmZEly1gnz7ub6ct2j31jn0u0tb7.jpg"><meta property="og:image" content="https://tva1.sinaimg.cn/large/008eGmZEly1gnz8byl9soj31360sqq4g.jpg"><meta property="og:image" content="https://tva1.sinaimg.cn/large/008eGmZEly1gnz8c1acqcj312y0ti403.jpg"><meta property="og:image" content="https://tva1.sinaimg.cn/large/008eGmZEly1gnz8c43rquj31300gujs4.jpg"><meta property="og:image" content="https://tva1.sinaimg.cn/large/008eGmZEly1gnz8fazzagj31340j43yq.jpg"><meta property="og:image" content="https://tva1.sinaimg.cn/large/008eGmZEly1gnz8gumd8lj313409omxd.jpg"><meta property="article:published_time" content="2020-07-26T09:29:51.000Z"><meta property="article:modified_time" content="2020-07-26T09:29:51.000Z"><meta property="article:author" content="Undeio"><meta property="article:tag" content="IAT"><meta property="article:tag" content="ASPack"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://tva1.sinaimg.cn/large/008eGmZEly1gnysy0v08kj31eb0u0ads.jpg"><link rel="canonical" href="https://undeio.me/posts/3969158325/"><script class="next-config" data-name="page" type="application/json">{&quot;sidebar&quot;:&quot;&quot;,&quot;isHome&quot;:false,&quot;isPost&quot;:true,&quot;lang&quot;:&quot;zh-CN&quot;,&quot;comments&quot;:true,&quot;permalink&quot;:&quot;https:&#x2F;&#x2F;undeio.me&#x2F;posts&#x2F;3969158325&#x2F;&quot;,&quot;path&quot;:&quot;posts&#x2F;3969158325&#x2F;&quot;,&quot;title&quot;:&quot;手动重建 IAT&quot;}</script><script class="next-config" data-name="calendar" type="application/json">&quot;&quot;</script><title>手动重建 IAT | 池塘·半亩</title><script src="/js/config.js"></script><meta name="msvalidate.01" content="E00B9090E8046D5EB6DD9B07EBEDFA2A"><script src="/js/third-party/analytics/baidu-analytics.js"></script><script async src="https://hm.baidu.com/hm.js?1dca64bee6b4ddd8e5704b56999cb693"></script><noscript><link rel="stylesheet" href="/css/noscript.css"></noscript></head><body itemscope itemtype="http://schema.org/WebPage" class="use-motion"><div class="headband"></div><main class="main"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏" role="button"><span class="toggle-line"></span> <span class="toggle-line"></span> <span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><h1 class="site-title">池塘·半亩</h1><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">业精于勤，荒于嬉。行成于思，毁于随。</p></div><div class="site-nav-right"><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-commonweal"><a href="/404/" rel="section"><i class="fa fa-heartbeat fa-fw"></i>公益 404</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"><input autocomplete="off" autocapitalize="off" maxlength="80" placeholder="搜索..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close" role="button"><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class="search-result-icon"><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></div><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span> <span class="toggle-line"></span> <span class="toggle-line"></span></div><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc">文章目录</li><li class="sidebar-nav-overview">站点概览</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E5%B7%A5%E5%85%B7"><span class="nav-number">1.</span> <span class="nav-text">使用工具</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%BE%93%E5%85%A5%E8%A1%A8%E9%87%8D%E5%BB%BA%E7%9A%84%E5%8E%9F%E7%90%86"><span class="nav-number">2.</span> <span class="nav-text">输入表重建的原理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%A1%AE%E5%AE%9A-IAT-%E7%9A%84%E5%9C%B0%E5%9D%80%E5%92%8C%E5%A4%A7%E5%B0%8F"><span class="nav-number">3.</span> <span class="nav-text">确定 IAT 的地址和大小</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A0%B9%E6%8D%AE-IAT-%E9%87%8D%E5%BB%BA%E8%BE%93%E5%85%A5%E8%A1%A8"><span class="nav-number">4.</span> <span class="nav-text">根据 IAT 重建输入表</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" alt="Undeio" src="/images/avatar.jpg"><p class="site-author-name" itemprop="name">Undeio</p><div class="site-description" itemprop="description">也许似乎大概是，然而未必不见得。</div></div><div class="site-state-wrap site-overview-item animated"><nav class="site-state"><div class="site-state-item site-state-posts"><a href="/archives"><span class="site-state-item-count">53</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class="site-state-item-count">9</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/"><span class="site-state-item-count">33</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author site-overview-item animated"><span class="links-of-author-item"><a href="https://github.com/Undeio" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Undeio" rel="noopener external nofollow noreferrer" target="_blank"><i class="fab fa-github fa-fw"></i></a> </span><span class="links-of-author-item"><a href="mailto:sean_link@live.com" title="E-Mail → mailto:sean_link@live.com" rel="noopener external nofollow noreferrer" target="_blank"><i class="fa fa-envelope fa-fw"></i></a></span></div><div class="cc-license site-overview-item animated" itemprop="license"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" class="cc-opacity" rel="noopener external nofollow noreferrer" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.css"><script src="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/meting@2.0.1/dist/Meting.min.js"></script><meting-js server="tencent" type="playlist" id="7909488549" order="random" list-max-height="146px"></meting-js></div></div><div class="back-to-top animated" role="button" aria-label="返回顶部"><i class="fa fa-arrow-up"></i> <span>0%</span></div></div></aside><div class="sidebar-dimmer"></div></header><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner post posts-expand"><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://undeio.me/posts/3969158325/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="Undeio"><meta itemprop="description" content="也许似乎大概是，然而未必不见得。"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="池塘·半亩"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">手动重建 IAT</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2020-07-26 17:29:51" itemprop="dateCreated datePublished" datetime="2020-07-26T17:29:51+08:00">2020-07-26</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B/" itemprop="url" rel="index"><span itemprop="name">逆向工程</span></a> </span>， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E8%84%B1%E5%A3%B3%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index"><span itemprop="name">脱壳技术</span></a> </span>， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Windows/" itemprop="url" rel="index"><span itemprop="name">Windows</span></a></span></span></div></div></header><div class="post-body" itemprop="articleBody"><blockquote><p>破坏原程序的输入表是加密外壳必备的功能，因此在脱壳中，输入表的处理是一个关键环节，这需要脱壳者对 PE 格式中输入表的概念必须非常清楚；</p><p>手动修复可以更清晰的理解重建输入表的过程及原理，但很辛苦，需要细心细心再细心，中间因为数值填错而苦苦寻找，想象一下在一堆二进制中找一个数值错误，很可怕，但很值得，弄懂了原理，以后就善用工具了；</p></blockquote><h4 id="使用工具"><a href="#使用工具" class="headerlink" title="使用工具"></a>使用工具</h4><ul><li><a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/Undeio/undeio.github.io/releases/tag/Tool-1">OllyDbg 1.10</a>原版，简称<code>OD</code>；</li><li><code>OD</code> <code>汉化</code>和<code>插件</code>均来自互联网；</li><li><a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/Undeio/undeio.github.io/releases/tag/CrackMe-7">UnPackMe</a>来自互联网，仅供学习使用；</li><li>加壳工具为<a target="_blank" rel="noopener external nofollow noreferrer" href="http://www.aspack.com/">ASPACK</a>：收费软件，可以试用；</li><li>Dump 工具为 <a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/Undeio/undeio.github.io/releases/tag/Tool-2">LoadPE</a>，来自互联网；</li><li>16 进制修改器为 WinHex；</li><li>文中特殊数字均是<code>HEX</code>，为了书写方便采用<code>DEC</code>；<span id="more"></span></li></ul><h4 id="输入表重建的原理"><a href="#输入表重建的原理" class="headerlink" title="输入表重建的原理"></a>输入表重建的原理</h4><p>在输入表结构中，与实际运行相关的主要是 IAT 结构，这个结构用于保存 API 的实际地址；</p><p>PE 文件运行时将初始化输入表的这一部分：</p><ul><li>Windows 加载器首先搜索 OriginalFirstThunk；</li><li>如果存在，加载程序将迭代搜索数组中的每个指针，找到每个 IMAGE_IMPORT_BY_NAME 结构所指向的输入函数的地址；</li><li>然后，加载器用函数真正的入口地址代替由 FirstThunk 指向的 IMAGE_THUNK_DATA 数组中元素的值；</li><li>初始化结束后，输入表中的其它部分就不重要了，程序依靠 IAT 提供的函数地址就可以正常运行；</li></ul><p>外壳程序一般都会修改原程序文件的输入，然后自己模仿 PE 装载器来填充 IAT 中的相关数据，也就是说，内存中只有一个 IAT，原程序的输入表不在内存中；</p><p>输入表重建就是根据这个 IAT 还原整个输入表的结构，包括 IID 结构以及其它各成员指向的数据等；</p><p>一些加密软件为了防止输入表被还原，在 IAT 加密上大作文章，此时，由外壳填充到 IAT 中的不是实际的 API 地址，而是用于 Hook API 的外壳代码的地址；</p><p>这样，外壳中的代码一旦完成了加载工作，在进入原程序的代码之后，仍然能够间接获得程序的控制权；</p><p>因为程序总要与系统打交道，与系统打交道的途径是 API，而 API 的地址已经被替换为外壳的 Hook API 的地址，所以，每次程序与系统打交道，都会让外壳程序获得一次控制权；</p><p>这样，外壳就可以进行反跟踪，从而继续保护软件，同时完成某些特殊任务了；</p><p>综上所述，重建输入表的关键是获取未加密的 IAT，一般的做法是跟踪加壳程序对 IAT 的处理过程，修改相关指令，不让外壳加密 IAT；</p><h4 id="确定-IAT-的地址和大小"><a href="#确定-IAT-的地址和大小" class="headerlink" title="确定 IAT 的地址和大小"></a>确定 IAT 的地址和大小</h4><p>输入表重建的关键是 IAT 的获得；</p><p>一般程序的 IAT 是连续排列的，以一个 DWORD 字的 0 作为结束，因此，只要确定 IAT 的一个点，就能获得整个 IAT 的地址和大小；</p><p>程序中的每一个 API 函数在 IAT 中都有自己的位置，这样，无论在代码中调用函数多少次，都会通过 IAT 中的同一个函数指针来完成；</p><p>程序调用输入函数分为直接调用和间接调用：</p><p>直接调用：<code>CALL DWORD PTR [00401506]</code>，直接调用跳转的地址就是函数的行首；</p><p>间接调用：<code>CALL &lt;JMP.&amp;KERNEL32.GetModuleHandleA&gt;</code>，间接调用是获取跳转地址存储的内容，然后调用；</p><p>以 CM 为例：</p><p><img data-src="https://tva1.sinaimg.cn/large/008eGmZEly1gnysy0v08kj31eb0u0ads.jpg" alt="间接调用"></p><p>此处为间接调用，在选择行按下 Enter 键即可到调用位置：</p><p><img data-src="https://tva1.sinaimg.cn/large/008eGmZEly1gnyszz3dehj31ef0u00x0.jpg" alt="调用位置"></p><p>这里有很多跳转至输入函数的指令，也可以说是 IAT 吧（IAT 跳转表）；</p><p>IAT 是一块连续排列的数据，因此，可以向上滚动屏幕，直到没有跳转，就是 IAT 的起始位置；</p><p><img data-src="https://tva1.sinaimg.cn/large/008eGmZEly1gnyt7wfurwj318v0u079r.jpg" alt="IAT 的起始位置"></p><p>可以看到，当前地址之前的数据为 0，所以可以确定，这里就是 IAT 的起始位置；</p><p>既然起始位置是向上滚动，结束位置肯定是向下滚动：</p><p><img data-src="https://tva1.sinaimg.cn/large/008eGmZEly1gnyteiv2nrj31fq0u0n2f.jpg" alt="IAT 结束位置"></p><p>需要注意的是，IAT 中的 IID 结构数组以 NULL 确定数据的结尾，所以，IAT 的结尾不是最后一个跳转指向的地址，而是下一个 DWORD <code>00000000</code>；</p><p>为了更直观地观察，可以让数据窗口直接显示这些 API 函数，以确定 IAT 是否正确：</p><p><img data-src="https://tva1.sinaimg.cn/large/008eGmZEly1gnytpedhm7j31ds0u0tde.jpg" alt="直观地观察"></p><p>设置数据窗口显示方式后，可以更直观地看到 IAT 的起始地址和结束地址；</p><h4 id="根据-IAT-重建输入表"><a href="#根据-IAT-重建输入表" class="headerlink" title="根据 IAT 重建输入表"></a>根据 IAT 重建输入表</h4><ol><li><p>使用 ASPACK 加密 CM，然后导入 OD；</p></li><li><p>使用栈平衡法定位并跳转至 OEP；</p></li><li><p>运行 LoadPE，将内存数据 Dump 出来并保存（Dump 过程中不能关闭 OD）：</p><p>Dump（转存）是指把内存指定地址的映像文件读出，用文件等形式将其保存下来的过程；</p><p>在程序到达 OEP 且没有运行时，Dump 是正确的，而程序运行后，由于一些变量已经初始化了，所以不适合 Dump；</p><p>在外壳处理过程中，外壳要把压缩后的全部代码数据释放到内存中，并初始化一些项目，因此，在此过程中也可以选择合适的位置进行 Dump；</p><p>常用的 Dump 软件有 LoadPE、PETool- 等，这类工具一般利用 Module32Next 来获取欲 Dump 进程的基本信息；</p><p>首先设置 LoadPE，勾选完整转存选项：</p><p><img data-src="https://tva1.sinaimg.cn/large/008eGmZEly1gnyu1ofv8cj30so0is74t.jpg" alt="设置 LoadPE"></p><p>设置完成后，在 LoadPE 的进程窗口中选择 CM 的进程，然后单击右键，在弹出的快捷菜单中执行“完整转存”命令，抓取并保存：</p><p><img data-src="https://tva1.sinaimg.cn/large/008eGmZEly1gnyu86qvv6j30ys0jaab0.jpg" alt="Dump"></p><p>注意保存文件的后缀，默认为 .dll 需要修改为 .exe；</p></li><li><p>运行 dumped.exe 发现不能运行：</p><p><img data-src="https://tva1.sinaimg.cn/large/008eGmZEly1gnyub982ydj30pe0eyq3b.jpg" alt="不能运行"></p><p>将 dumped.exe 导入 OD，在弹出错误弹窗后，程序并没有停在 OEP 位置，说明异常是在初始化时产生的：</p><p><img data-src="https://tva1.sinaimg.cn/large/008eGmZEly1gnyuihwfs0j31e40u00vv.jpg" alt="异常是在初始化时产生的"></p><p>查看 log 窗口，发现创建进程后异常就发生了，程序都没有完成初始化；</p></li><li><p>回到反汇编窗口，goto 到 OEP，然后来到 IAT 表：</p><p><img data-src="https://tva1.sinaimg.cn/large/008eGmZEly1gnyux7yeyaj318b0u00xf.jpg" alt="来到 IAT 表"></p><p>发现 PE 加载器在搜索 OriginalFirstThunk 数组时异常了；</p><p>这时，就需要修复了；</p></li><li><p>回到之前的 OD，通过查看 IAT 可以看到，CM 使用了 5 个 DLL，分别是：user32.dll、kernel32.dll、comctl32.dll、GDI32.dll、comdlg32.dll，它们分别对应一个 IAT，IAT 之间以一个 DWORD 类型的 0 隔开，整理 IAT 成员的函数：</p><table><thead><tr><th align="center">user32.dll</th><th align="center">kernel32.dll</th><th align="center">comctl32.dll</th><th align="center">GDI32.dll</th><th align="center">comdlg32.dll</th></tr></thead><tbody><tr><td align="center">KillTimer</td><td align="center">GetLocalTime</td><td align="center">InitCommonControls</td><td align="center">TextOutA</td><td align="center">GetSaveFileNameA</td></tr><tr><td align="center">GetSystemMetrics</td><td align="center">OpenFile</td><td align="center">CreateToolbarEx</td><td align="center">StartPage</td><td align="center">GetOpenFileNameA</td></tr><tr><td align="center">LoadCursorA</td><td align="center">GlobalFree</td><td align="center">CreateToolbar</td><td align="center">StartDocA</td><td align="center">PrintDlgA</td></tr><tr><td align="center">LoadAcceleratorsA</td><td align="center">GlobalAlloc</td><td align="center"></td><td align="center">GetTextMetricsA</td><td align="center"></td></tr><tr><td align="center">MessageBeep</td><td align="center">lstrlenA</td><td align="center"></td><td align="center">GetStockObject</td><td align="center"></td></tr><tr><td align="center">GetWindowRect</td><td align="center">CloseHandle</td><td align="center"></td><td align="center">EndPage</td><td align="center"></td></tr><tr><td align="center">LoadStringA</td><td align="center">WriteFile</td><td align="center"></td><td align="center">EndDoc</td><td align="center"></td></tr><tr><td align="center">LoadIconA</td><td align="center">GetModuleHandleA</td><td align="center"></td><td align="center">DeleteObject</td><td align="center"></td></tr><tr><td align="center">LoadBitmapA</td><td align="center">ReadFile</td><td align="center"></td><td align="center">DeleteDC</td><td align="center"></td></tr><tr><td align="center">SetFocus</td><td align="center">ExitProcess</td><td align="center"></td><td align="center"></td><td align="center"></td></tr><tr><td align="center">MessageBoxA</td><td align="center"></td><td align="center"></td><td align="center"></td><td align="center"></td></tr><tr><td align="center">PostQuitMessage</td><td align="center"></td><td align="center"></td><td align="center"></td><td align="center"></td></tr><tr><td align="center">WinHelpA</td><td align="center"></td><td align="center"></td><td align="center"></td><td align="center"></td></tr><tr><td align="center">InvalidateRect</td><td align="center"></td><td align="center"></td><td align="center"></td><td align="center"></td></tr><tr><td align="center">TranslateAcceleratorA</td><td align="center"></td><td align="center"></td><td align="center"></td><td align="center"></td></tr><tr><td align="center">MoveWindow</td><td align="center"></td><td align="center"></td><td align="center"></td><td align="center"></td></tr><tr><td align="center">TranslateMessage</td><td align="center"></td><td align="center"></td><td align="center"></td><td align="center"></td></tr><tr><td align="center">LoadMenuA</td><td align="center"></td><td align="center"></td><td align="center"></td><td align="center"></td></tr><tr><td align="center">ShowWindow</td><td align="center"></td><td align="center"></td><td align="center"></td><td align="center"></td></tr><tr><td align="center">SendMessageA</td><td align="center"></td><td align="center"></td><td align="center"></td><td align="center"></td></tr><tr><td align="center">SetTimer</td><td align="center"></td><td align="center"></td><td align="center"></td><td align="center"></td></tr><tr><td align="center">SetWindowPos</td><td align="center"></td><td align="center"></td><td align="center"></td><td align="center"></td></tr><tr><td align="center">UpdateWindow</td><td align="center"></td><td align="center"></td><td align="center"></td><td align="center"></td></tr><tr><td align="center">RegisterClassA</td><td align="center"></td><td align="center"></td><td align="center"></td><td align="center"></td></tr><tr><td align="center">BeginPaint</td><td align="center"></td><td align="center"></td><td align="center"></td><td align="center"></td></tr><tr><td align="center">CreateWindowExA</td><td align="center"></td><td align="center"></td><td align="center"></td><td align="center"></td></tr><tr><td align="center">DefWindowProcA</td><td align="center"></td><td align="center"></td><td align="center"></td><td align="center"></td></tr><tr><td align="center">DialogBoxParamA</td><td align="center"></td><td align="center"></td><td align="center"></td><td align="center"></td></tr><tr><td align="center">DispatchMessageA</td><td align="center"></td><td align="center"></td><td align="center"></td><td align="center"></td></tr><tr><td align="center">DrawMenuBar</td><td align="center"></td><td align="center"></td><td align="center"></td><td align="center"></td></tr><tr><td align="center">EndDialog</td><td align="center"></td><td align="center"></td><td align="center"></td><td align="center"></td></tr><tr><td align="center">EndPaint</td><td align="center"></td><td align="center"></td><td align="center"></td><td align="center"></td></tr><tr><td align="center">FindWindowA</td><td align="center"></td><td align="center"></td><td align="center"></td><td align="center"></td></tr><tr><td align="center">GetDC</td><td align="center"></td><td align="center"></td><td align="center"></td><td align="center"></td></tr><tr><td align="center">GetDlgItem</td><td align="center"></td><td align="center"></td><td align="center"></td><td align="center"></td></tr><tr><td align="center">GetDlgItemTextA</td><td align="center"></td><td align="center"></td><td align="center"></td><td align="center"></td></tr><tr><td align="center">GetMessageA</td><td align="center"></td><td align="center"></td><td align="center"></td><td align="center"></td></tr></tbody></table></li><li><p>接下来就是修复了，使用 WinHex 打开 dumped.exe，在文件中找到一块空白空间，将表中的 DLL 名和函数名写进去：</p><p><img data-src="https://tva1.sinaimg.cn/large/008eGmZEly1gnywqu2k84j31ue0h0qaq.jpg" alt="函数数据"></p><p>为了加深对输入表的理解，手动。。。</p><p><img data-src="https://tva1.sinaimg.cn/large/008eGmZEly1gnyx9ny4d8j318f0u00vz.jpg" alt="写进去"></p><p>写入数据时：</p><ul><li><p>每个函数前面要留 2 个字节来存放函数的序号，序号可以为 0；</p></li><li><p>每个函数后的 1 字节为 0，即以 0 结尾；</p></li><li><p>每个函数名或 DLL 名的起始位置必须按偶数对齐，空隙用 0 填充；</p></li></ul><p>因为 dumped.exe 是内存映像文件，所以文件偏移地址和相对虚拟地址（RVA）是相等的；</p><p>整理 DLL 名和 API 名所在的偏移地址：</p><table><thead><tr><th align="center">DLL 或 API 名称</th><th align="center">地址</th><th align="center">API 名称</th><th align="center">地址</th></tr></thead><tbody><tr><td align="center">user32.dll</td><td align="center">00002200</td><td align="center">user32.dll 中的 API 👇👇👇</td><td align="center"></td></tr><tr><td align="center">KillTimer</td><td align="center">00002240</td><td align="center">GetSystemMetrics</td><td align="center">0000224C</td></tr><tr><td align="center">LoadCursorA</td><td align="center">00002260</td><td align="center">LoadAcceleratorsA</td><td align="center">0000226E</td></tr><tr><td align="center">MessageBeep</td><td align="center">00002282</td><td align="center">GetWindowRect</td><td align="center">00002290</td></tr><tr><td align="center">LoadStringA</td><td align="center">000022A0</td><td align="center">LoadIconA</td><td align="center">000022AE</td></tr><tr><td align="center">LoadBitmapA</td><td align="center">000022BA</td><td align="center">SetFocus</td><td align="center">000022C8</td></tr><tr><td align="center">MessageBoxA</td><td align="center">000022D4</td><td align="center">PostQuitMessage</td><td align="center">000022E2</td></tr><tr><td align="center">WinHelpA</td><td align="center">000022F4</td><td align="center">InvalidateRect</td><td align="center">00002300</td></tr><tr><td align="center">TranslateAcceleratorA</td><td align="center">00002312</td><td align="center">MoveWindow</td><td align="center">0000232A</td></tr><tr><td align="center">TranslateMessage</td><td align="center">00002338</td><td align="center">LoadMenuA</td><td align="center">000234C</td></tr><tr><td align="center">ShowWindow</td><td align="center">00002358</td><td align="center">SendMessageA</td><td align="center">00002366</td></tr><tr><td align="center">SetTimer</td><td align="center">00002376</td><td align="center">SetWindowPos</td><td align="center">00002382</td></tr><tr><td align="center">UpdateWindow</td><td align="center">00002392</td><td align="center">RegisterClassA</td><td align="center">000023A2</td></tr><tr><td align="center">BeginPaint</td><td align="center">000023B4</td><td align="center">CreateWindowExA</td><td align="center">000023C2</td></tr><tr><td align="center">DefWindowProcA</td><td align="center">000023D4</td><td align="center">DialogBoxParamA</td><td align="center">000023E6</td></tr><tr><td align="center">DispatchMessageA</td><td align="center">000023F8</td><td align="center">DrawMenuBar</td><td align="center">0000240C</td></tr><tr><td align="center">EndDialog</td><td align="center">0000241A</td><td align="center">EndPaint</td><td align="center">00002426</td></tr><tr><td align="center">FindWindowA</td><td align="center">00002432</td><td align="center">GetDC</td><td align="center">00002440</td></tr><tr><td align="center">GetDlgItem</td><td align="center">00002448</td><td align="center">GetDlgItemTextA</td><td align="center">00002456</td></tr><tr><td align="center">GetMessageA</td><td align="center">00002468</td><td align="center"></td><td align="center"></td></tr><tr><td align="center">kernel32.dll</td><td align="center">0000220C</td><td align="center">kernel32.dll 中的 API 👇👇👇</td><td align="center"></td></tr><tr><td align="center">GetLocalTime</td><td align="center">00002476</td><td align="center">OpenFile</td><td align="center">00002486</td></tr><tr><td align="center">GlobalFree</td><td align="center">00002492</td><td align="center">GlobalAlloc</td><td align="center">000024A0</td></tr><tr><td align="center">lstrlenA</td><td align="center">000024AE</td><td align="center">CloseHandle</td><td align="center">000024B8</td></tr><tr><td align="center">WriteFile</td><td align="center">000024C6</td><td align="center">GetModuleHandleA</td><td align="center">000024D2</td></tr><tr><td align="center">ReadFile</td><td align="center">000024E6</td><td align="center">ExitProcess</td><td align="center">000024F2</td></tr><tr><td align="center">comctl32.dll</td><td align="center">0000221A</td><td align="center">comctl32.dll 中的 API 👇👇👇</td><td align="center"></td></tr><tr><td align="center">InitCommonControls</td><td align="center">00002500</td><td align="center">CreateToolbarEx</td><td align="center">00002516</td></tr><tr><td align="center">CreateToolbar</td><td align="center">00002528</td><td align="center"></td><td align="center"></td></tr><tr><td align="center">GDI32.dll</td><td align="center">00002228</td><td align="center">GDI32.dll 中的 API 👇👇👇</td><td align="center"></td></tr><tr><td align="center">TextOutA</td><td align="center">00002538</td><td align="center">StartPage</td><td align="center">00002544</td></tr><tr><td align="center">StartDocA</td><td align="center">00002550</td><td align="center">GetTextMetricsA</td><td align="center">0000255C</td></tr><tr><td align="center">GetStockObject</td><td align="center">0000256E</td><td align="center">EndPage</td><td align="center">00002580</td></tr><tr><td align="center">EndDoc</td><td align="center">0000258A</td><td align="center">DeleteObject</td><td align="center">00002594</td></tr><tr><td align="center">DeleteDC</td><td align="center">000025A4</td><td align="center"></td><td align="center"></td></tr><tr><td align="center">comdlg32.dll</td><td align="center">00002232</td><td align="center">comdlg32.dll 中的 API 👇👇👇</td><td align="center"></td></tr><tr><td align="center">GetSaveFileNameA</td><td align="center">000025B0</td><td align="center">GetOpenFileNameA</td><td align="center">000025C4</td></tr><tr><td align="center">PrintDlgA</td><td align="center">000025D8</td><td align="center"></td><td align="center"></td></tr></tbody></table><p>接着，构造指向函数名地址的 IMAGE_THUNK_DATA 数组：</p><p><img data-src="https://tva1.sinaimg.cn/large/008eGmZEly1gnz01e8sjhj318c0u0q5p.jpg" alt="IMAGE_THUNK_DATA 数组"></p><p>位置随意，两个数组之间的间隔为 2 字节，用 0 填充（小端序构建）；</p><p>然后构建其 IID 数组：</p><table><thead><tr><th align="center">DLL</th><th align="center">OrignalFirstThunk</th><th align="center">TimeDateStamp</th><th align="center">ForwardChain</th><th align="center">Name</th><th align="center">FirstThunk</th></tr></thead><tbody><tr><td align="center">user32.dll</td><td align="center">00290000</td><td align="center">00000000</td><td align="center">00000000</td><td align="center">00220000</td><td align="center">84310000</td></tr><tr><td align="center">kernel32.dll</td><td align="center">98290000</td><td align="center">00000000</td><td align="center">00000000</td><td align="center">0C220000</td><td align="center">1C320000</td></tr><tr><td align="center">comctl32.dll</td><td align="center">C4290000</td><td align="center">00000000</td><td align="center">00000000</td><td align="center">1A220000</td><td align="center">48320000</td></tr><tr><td align="center">GDI32.dll</td><td align="center">D4290000</td><td align="center">00000000</td><td align="center">00000000</td><td align="center">28220000</td><td align="center">58320000</td></tr><tr><td align="center">comdlg32.dll</td><td align="center">FC290000</td><td align="center">00000000</td><td align="center">00000000</td><td align="center">32220000</td><td align="center">80320000</td></tr><tr><td align="center">（结束标志 ）</td><td align="center">00000000</td><td align="center">00000000</td><td align="center">00000000</td><td align="center">00000000</td><td align="center">00000000</td></tr></tbody></table><p>接下来，使用 LoadPE 修改输入表地址：</p><p><img data-src="https://tva1.sinaimg.cn/large/008eGmZEly1gnz7h6rl86j30n60lsdg9.jpg" alt="使用 LoadPE修改输入表地址"></p><p>修改完成后，运行程序，一切正确，这就完了吗？并没有；</p><p>将 dumped.exe 导入 OD：</p><p><img data-src="https://tva1.sinaimg.cn/large/008eGmZEly1gnz7m49balj313806sdg1.jpg" alt="弹出警告"></p><p>程序会弹出提示入口点超出代码段范围的警告，所以，还需要修改 OEP：</p><p><img data-src="https://tva1.sinaimg.cn/large/008eGmZEly1gnz7r455y1j31dw0u0n0a.jpg" alt="修改OEP"></p><p>修改 OEP 为正常数值，并保存修改到可执行文件；</p><p>将保存的文件导入 OD，然后检查 IAT，有数据才算正常：</p><p><img data-src="https://tva1.sinaimg.cn/large/008eGmZEly1gnz7ub6ct2j31jn0u0tb7.jpg" alt="检查IAT"></p></li><li><p>总结一下：</p><ul><li>构建 IMAGE_IMPORT_BY_NAME 结构体，用来存储 DLL 名和 API 名；</li><li>构建 IMAGE_THUNK_DATA 结构体，指向函数名对应的地址；</li><li>构建 IID 结构体，OrignalFirstThunk 指向 IMAGE_THUNK_DATA 对应的起始地址，Name 指向 IMAGE_IMPORT_BY_NAME 对应的地址，FirstThunk 指向原程序的 IAT 表；</li><li>构建过程中，每项的注意事项不再赘述；</li></ul></li><li><p>所有修改如下：</p><ul><li><p>IMAGE_IMPORT_BY_NAME：</p><p><img data-src="https://tva1.sinaimg.cn/large/008eGmZEly1gnz8byl9soj31360sqq4g.jpg" alt="1"><img data-src="https://tva1.sinaimg.cn/large/008eGmZEly1gnz8c1acqcj312y0ti403.jpg" alt="2"><img data-src="https://tva1.sinaimg.cn/large/008eGmZEly1gnz8c43rquj31300gujs4.jpg" alt="3"></p></li><li><p>IMAGE_THUNK_DATA：</p><p><img data-src="https://tva1.sinaimg.cn/large/008eGmZEly1gnz8fazzagj31340j43yq.jpg" alt="4"></p></li><li><p>IID：<br><img data-src="https://tva1.sinaimg.cn/large/008eGmZEly1gnz8gumd8lj313409omxd.jpg" alt="5"></p></li></ul></li></ol></div><footer class="post-footer"><div class="post-copyright"><ul><li class="post-copyright-author"><strong>本文作者： </strong>Undeio</li><li class="post-copyright-link"><strong>本文链接：</strong> <a href="https://undeio.me/posts/3969158325/" title="手动重建 IAT">https://undeio.me/posts/3969158325/</a></li><li class="post-copyright-license"><strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="noopener external nofollow noreferrer" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><div class="post-tags"><a href="/tags/IAT/" rel="tag"><i class="fa fa-tag"></i> IAT</a> <a href="/tags/ASPack/" rel="tag"><i class="fa fa-tag"></i> ASPack</a></div><div class="post-nav"><div class="post-nav-item"><a href="/posts/4132012963/" rel="prev" title="编译语言特点定位 OEP"><i class="fa fa-chevron-left"></i> 编译语言特点定位 OEP</a></div><div class="post-nav-item"><a href="/posts/452711586/" rel="next" title="修复 IAT 之初探">修复 IAT 之初探 <i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><div class="comments utterances-container"></div><script src="/js/comments.js"></script></div></main><footer class="footer"><div class="footer-inner"><div class="copyright">&copy; <span itemprop="copyrightYear">2021</span> <span class="with-love"><i class="fa fa-heart"></i> </span><span class="author" itemprop="copyrightHolder">Undeio</span></div><div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener external nofollow noreferrer" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" class="theme-link" rel="noopener external nofollow noreferrer" target="_blank">NexT.Gemini</a> 强力驱动</div><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="busuanzi"><span id="busuanzi_container_site_pv" style="display:none">本站访问量<span id="busuanzi_value_site_pv"></span>次 </span><span>|</span> <span id="busuanzi_container_site_uv" style="display:none">本站访客数<span id="busuanzi_value_site_uv"></span>人次</span></div><script>function printIP(){fetch("https://ipapi.co/ip/").then(function(t){t.text().then(t=>{let e=document.getElementsByClassName("footer-inner")[0],n=document.createElement("div");return n.setAttribute("class","ip"),n.innerHTML="本次访问IP: "+t,e&&e.appendChild(n),t})}).catch(function(t){console.log(t)})}printIP()</script></div></footer><script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@next-theme/pjax@0.5.0/pjax.min.js"></script><script src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js"></script><script src="https://cdn.jsdelivr.net/npm/lozad@1.16.0/dist/lozad.min.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script><script src="/js/pjax.js"></script><script src="/js/third-party/search/local-search.js"></script><script class="next-config" data-name="mermaid" type="application/json">{&quot;enable&quot;:true,&quot;theme&quot;:&quot;forest&quot;,&quot;js&quot;:&quot;https:&#x2F;&#x2F;cdn.jsdelivr.net&#x2F;npm&#x2F;mermaid@8.9.3&#x2F;dist&#x2F;mermaid.min.js&quot;}</script><script src="/js/third-party/tags/mermaid.js"></script><script class="next-config" data-name="enableMath" type="application/json">false</script><script class="next-config" data-name="mathjax" type="application/json">{&quot;enable&quot;:true,&quot;tags&quot;:&quot;none&quot;,&quot;js&quot;:&quot;https:&#x2F;&#x2F;cdn.jsdelivr.net&#x2F;npm&#x2F;mathjax@3.1.4&#x2F;es5&#x2F;tex-mml-chtml.js&quot;}</script><script src="/js/third-party/math/mathjax.js"></script><script class="next-config" data-name="utterances" type="application/json">{&quot;enable&quot;:true,&quot;repo&quot;:&quot;Undeio&#x2F;undeio.github.io&quot;,&quot;issue_term&quot;:&quot;title&quot;,&quot;theme&quot;:&quot;github-light&quot;}</script><script src="/js/third-party/comments/utterances.js"></script></body></html>